
#cloud-config
package_update: true
package_upgrade: true

packages:
  - apache2
  - mysql-server
  - php
  - php-mysql
  - libapache2-mod-php
  - php-cli
  - php-curl
  - php-gd
  - php-mbstring
  - php-xml
  - php-xmlrpc
  - unzip
  - wget
  - certbot
  - python3-certbot-apache

runcmd:
  - export DEBIAN_FRONTEND=noninteractive

  # MySQL konfigurieren
  - |
    sudo systemctl enable mysql
    sudo systemctl start mysql
    sleep 10
    sudo mysql -e "ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY 'MySQLRootPass!2025'; FLUSH PRIVILEGES;"
    sudo mysql -uroot -pMySQLRootPass!2025 -e "CREATE DATABASE wordpressdb;"
    sudo mysql -uroot -pMySQLRootPass!2025 -e "CREATE USER 'wpuser'@'localhost' IDENTIFIED BY 'WpUserPass!2025';"
    sudo mysql -uroot -pMySQLRootPass!2025 -e "GRANT ALL PRIVILEGES ON wordpressdb.* TO 'wpuser'@'localhost'; FLUSH PRIVILEGES;"

  # WordPress installieren
  - |
    cd /tmp
    wget https://wordpress.org/latest.tar.gz
    tar -xzf latest.tar.gz
    sudo mv wordpress/* /var/www/html/
    sudo chown -R www-data:www-data /var/www/html/
    sudo chmod -R 755 /var/www/html/
    sudo rm -f /var/www/html/index.html

  # wp-config.php anpassen
  - |
    cd /var/www/html
    cp wp-config-sample.php wp-config.php
    sed -i "s/database_name_here/wordpressdb/" wp-config.php
    sed -i "s/username_here/wpuser/" wp-config.php
    sed -i "s/password_here/WpUserPass!2025/" wp-config.php

  # WordPress Admin-User automatisch erstellen
  - |
    sudo -u www-data php /var/www/html/wp-cli.phar core install --url="http://$(curl -s ifconfig.me)" --title="My WordPress Site" --admin_user="wpadmin" --admin_password="WpAdminPass!2025" --admin_email="admin@example.com"

  # phpMyAdmin vorkonfigurieren
  - |
    echo "phpmyadmin phpmyadmin/dbconfig-install boolean true" | sudo debconf-set-selections
    echo "phpmyadmin phpmyadmin/app-password-confirm password MySQLRootPass!2025" | sudo debconf-set-selections
    echo "phpmyadmin phpmyadmin/mysql/admin-pass password MySQLRootPass!2025" | sudo debconf-set-selections
    echo "phpmyadmin phpmyadmin/mysql/app-pass password MySQLRootPass!2025" | sudo debconf-set-selections
    echo "phpmyadmin phpmyadmin/reconfigure-webserver multiselect apache2" | sudo debconf-set-selections
    sudo apt-get install -y phpmyadmin
    sudo ln -s /usr/share/phpmyadmin /var/www/html/phpmyadmin
    echo "Include /etc/phpmyadmin/apache.conf" | sudo tee -a /etc/apache2/apache2.conf

  # Apache aktivieren
  - |
    sudo systemctl enable apache2
    sudo systemctl restart apache2

final_message: "WordPress und phpMyAdmin wurden erfolgreich installiert!"
